#!/bin/bash
#PBS -l walltime=01:00:00
#PBS -l select=1:ncpus=1:mem=1gb
#PBS -j oe                       
#PBS -o /$HOME/collusion/jobs/log/raw.$PBS_JOBID     

cd ${PBS_O_WORKDIR}


# make conda & python visible
export PATH="$HOME/miniforge3/bin:$PATH"
source ~/miniforge3/bin/activate collusion   # ← note single line


# --- build final filename with date & comment ---
stamp=$(date +%Y%m%d-%H%M)
logdir=$HOME/collusion/jobs/log
final="$logdir/collusion_${PBS_JOBID}_${stamp}.log"

# redirect everything from here on
exec >"$final" 2>&1

echo "Log file: $final"


python simulate.py

# --- on normal or error exit, append PBS epilogue ----
cleanup () {
    cat /home/$USER/jobs/logs/raw.$PBS_JOBID >> "$final"
    rm  /home/$USER/jobs/logs/raw.$PBS_JOBID
}
trap cleanup EXIT